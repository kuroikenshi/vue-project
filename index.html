<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui, viewport-fit=cover">
    <title>班级工具</title>

    <!-- WeUI -->
    <!-- <link rel="stylesheet" href="node_modules/weui/style/weui.min.css"/> -->
    <link rel="stylesheet" href="/banji/static/vendor/jquery-weui/css/jquery-weui.css"/>

  </head>
  <body>
    <div id="app"></div>
    <!-- built files will be auto injected -->

    <!-- 班级动态-评论框-遮罩层 -->
    <div class="weui-mask" id="commentMask" style="display: none"></div>
    <!-- 班级动态-评论框 -->
    <div class="weui-actionsheet" id="commentContainer" style="display: none;">
      <div class="commentbar">
        <form>
          <input type="text" class="commentbar-input" id="commentInput" onkeypress="if(event.keyCode == 13) return false;">
          <a href="javascript: void(0);" class="comment-button disabled" id="commentSubmit">提交</a>
        </form>
      </div>
    </div>

    <!-- 引入各类jquery插件 -->
    <script src="/banji/static/vendor/jquery/jquery.min.js"></script>
    <script src="/banji/static/vendor/jquery-weui/js/jquery-weui.js"></script>
    <script src="/banji/static/vendor/jquery-weui/js/swiper.js"></script>

    <script src="/banji/static/vendor/store/store.everything.min.js"></script>

    <script src="/banji/static/js/base.js"></script>

    <script>
      console.log('index.html中的script');
      
      // TODO: 替换成原生js
      // 给点赞按钮加特效(玩)
      $('body').on('touchstart', '.act-button', function () {
        this.classList.add('active');

        $(this).on('touchend', function () {
          this.classList.remove('active');
        });
      });


      /*
        评论框相关事件 == START ==
      */
      window.$commentMask = $('#commentMask')             // 遮罩层
      window.$commentContainer = $('#commentContainer')   // 弹出输入框容器
      window.$input = $('#commentInput')                  // 评论输入框
      window.$submit = $('#commentSubmit')                // 评论提交按钮

      // 给遮罩加点击事件
      $commentMask.on('click', function () {
        // 解决键盘收起来，画面键盘位置留白的问题
        window.scrollTo(0, 500);
        $commentContainer.removeClass('weui-actionsheet_toggle');
        $commentMask.fadeOut(200);
      });

      // 检查是否应该禁用提交
      function checkDisable($input) {
        if ($input.val().length == 0) {
          $('#commentSubmit').addClass('disabled')
        } else {
          $('#commentSubmit').removeClass('disabled')
        }
      }

      $input.on({
        // 输入时检查是否禁用
        'input': function () {
          checkDisable($(this))
        },
        // 获得焦点时检查是否禁用
        'focus': function () {
          checkDisable($(this))
        },
        // 输入框失去焦点滑动，解决点击"完成",键盘收起,但是tab有空白的问题
        'blur': function () {
          setTimeout(function() {
            window.scrollTo(0, 500);
          }, 0);
        }
      });
      /*
        评论框相关事件 === END ===
      */

      // 开始提交状态的方法
      window.backgroundSubmit = function(param) {
        // 提示开始任务
        window.vue.$weui.topTips('发布中，请勿关闭此页...', {
          duration: 60000,
          className: 'weui-toptips_visible xdf_orange',
        })

        // 批量上传图片
        let axiosList = []
        window.elementUrl = {}   // 这里用对象, 因为后边要根据idx排序输出values
        var uploadImagesIsFailed = false
        Array.from(param.imageFiles).forEach((imgFile, idx) => {
          let formData = new FormData()
          formData.append('file', imgFile)

          // 上传图片
          axiosList.push(window.vue.$axios.post('/banji/moments/uploadPic', formData).then(res => {
            if (res.status == 200 && res.data.status == 200) {
              console.log('图片上传成功')
              console.log(res, res.data)
              window.elementUrl[idx] = res.data.data   // 传完图片后更新图片url

              // 更新图片成功提示
              window.vue.$weui.topTips('发布中(' + Object.keys(window.elementUrl).length + '/' + param.imageFiles.length + ')，请勿关闭此页...', {
                duration: 60000,
                className: 'weui-toptips_visible xdf_orange',
              })
            } else {
              console.error("图片上传失败")
              uploadImagesIsFailed = true
            }
          }))
        })
        
        // 图片上传完成后,发布班级动态
        window.vue.$axios.all(axiosList).then(window.vue.$axios.spread(function (userResp, reposResp) {
          if (uploadImagesIsFailed) {
            window.weuiErr('发布失败！因为有图片上传不成功！')
            uploadImagesIsFailed = false
          }
          else {
            // 拼合图片url的数组字符串
            let urlsString = ''
            if (Object.values(elementUrl).length > 0) {
              urlsString = '["'
              urlsString += Object.values(elementUrl).join('","')
              urlsString += '"]'
            }

            // 成功后,获取图片url,拼装数据
            let postData = window.vue.$qs.stringify({
              content: param.content,
              classCode: param.classCode,
              type: param.type,
              elementUrl: urlsString
            })

            // 提交
            window.vue.$axios.post('/banji/moments/publishMoment', postData).then(res => {
              console.log('publishComment>>>', res.data)

              // 成功后提示
              window.weuiSuccess('发布成功！')
              setTimeout(function() {
                console.log('刷新')
                // 刷新页面(没法使用provide/inject方式实现)
                window.vue.$router.push('/refresh')

              }, 1000)

              return Promise.resolve()
            }).catch(err => {
              // 失败后提示
              window.weuiErr('发布失败！' + err.toString())
              return Promise.reject(err)
            })
          }
        }))
        
        // 跳转到指定班级动态页面
        window.vue.$router.push('/class/' + param.classCode + '/moments')
      }

      // 绑定用户的localstorage
      class UserLocalStorage {
        constructor () {
          // console.log('UserLocalStorage - constructor username:', username)
          // this.username = username
        }

        init (userid) {
          this.userid = userid
          console.log('uls 初始化 userid:', userid)
        }

        isReady () {
          console.log('uls.isReady>>>',
            '\n    this.userid:', (!!this.userid),
            '\n     st.clastoo:', (typeof(store.get('clastoo')) === 'object'),
            '\n      ct.userid:', (typeof(store.get('clastoo')[this.userid]) === 'object'),
            '\n   keys.len > 0:', (Object.keys(store.get('clastoo')[this.userid]).length > 0),
            '\n >>>', (
              (!!this.userid) &&
              (typeof(store.get('clastoo')) === 'object') &&
              (typeof(store.get('clastoo')[this.userid]) === 'object') &&
              (Object.keys(store.get('clastoo')[this.userid]).length > 0)
            )
          )
          return (
            (!!this.userid) &&
            (typeof(store.get('clastoo')) === 'object') &&
            (typeof(store.get('clastoo')[this.userid]) === 'object') &&
            (Object.keys(store.get('clastoo')[this.userid]).length > 0)
          )
        }

        get (key1, key2) {
          let ulsData = store.get('clastoo')
          if (ulsData === undefined) {
            return undefined
          }

          let d = ulsData[this.userid]
          if (d === undefined) {
            return undefined
          }

          let obj = d[key1]
          if (obj === undefined) {
            return undefined
          }

          return obj[key2]
        }

        set (key1, key2, val) {
          let ulsData = store.get('clastoo')
          if (ulsData === undefined) {
            ulsData = {}
          }

          if (ulsData[this.userid] === undefined) {
            ulsData[this.userid] = {}
          }

          if (ulsData[this.userid][key1] === undefined) {
            ulsData[this.userid][key1] = {}
          }

          ulsData[this.userid][key1][key2] = val
          store.set('clastoo', ulsData)
        }

        del (key1, key2) {
          let ulsData = store.get('clastoo')

          let d = ulsData[this.userid]
          if (d === undefined) {
            console.error('uls.del 未找到当前ulsData, userid=' + this.userid)
            return false
          }

          let result = undefined
          // 指定了key1, key2: 尝试删除d[key1][key2]
          if (key2 != undefined && key1 != undefined) {
            if (d[key1] === undefined) {
              console.warn('d["' + key1 + '"] === undefined，忽略')
              return false
            }
            else if (d[key1][key2] === undefined) {
              console.warn('d["' + key1 + '"]["' + key2 + '"] === undefined，忽略')
              return false
            }
            else {
              result = delete d[key1][key2]
            }
          }
          // 只指定了key1: 尝试删除d[key1]
          else if (key1 != undefined) {
            if (d[key1] === undefined) {
              console.warn('d["' + key1 + '"] === undefined，忽略')
              return false
            }
            else {
              result = delete d[key1]
            }
          }
          else {
            console.warn('uls.del 未输入key1, key2')
            return false
          }

          store.set('clastoo', ulsData)
          return result
        }

        showAll () {
          let ulsData = store.get('clastoo')
          let d = ulsData[this.userid]
          let keys = Object.keys(d)
          for (let ki = 0; ki < keys.length; ki++) {
            let key = keys[ki]
            console.log(key + ':', d[key])
          }
        }
      }
      
      window.uls = new UserLocalStorage()

      // 如果store里有值,自动初始化uls,确保每次刷新时能继续加载当前用户的信息
      if (!!store.getAll().clastooCurrentUser) {
        let currentUserId = store.getAll().clastooCurrentUser;
        console.log('刷新后触发，加载当前用户的uls数据');
        
        console.info('  -- localStorage.getItem("clastooCurrentUser") =>', localStorage.getItem('clastooCurrentUser'));
        console.info('  ------------- store.get("clastooCurrentUser") =>', store.get('clastooCurrentUser'));
        console.info('  ------------------------------ store.getAll() =>', store.getAll().clastooCurrentUser);
        
        // debugger
        window.uls.init(currentUserId);
      }
      else {
        console.error('store.get("clastooCurrentUser") =>', store.get('clastooCurrentUser'), '请检查');
        console.info('  -- localStorage.getItem("clastooCurrentUser") =>', localStorage.getItem('clastooCurrentUser'));
        console.info('  ------------- store.get("clastooCurrentUser") =>', store.get('clastooCurrentUser'));
        console.info('  ------------------------------ store.getAll() =>', store.getAll().clastooCurrentUser);
      }

      /*
        评论框相关事件 === END ===
      */

      // ios软键盘收回后向 页面向下滑动500px(造成对提交按钮的阻塞，直接放到提交按钮上去)
      /* document.body.addEventListener('focusout', function () {
          window.scrollTo(0, 500);
      }); */

      // 给String扩展按照urlParam方式获取key的value的方法 => 使用window.vue.$qs.parse替换
      /* String.prototype.getUrlParam = function (key) {
        var reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = this.match(reg);  //匹配目标参数
        if (r != null) return decodeURI(r[2]); return null; //返回参数值
      } */

      /*window.onload = function(){
        if (document.documentElement.scrollHeight <= document.documentElement.clientHeight) {
          bodyTag = document.getElementsByTagName('body')[0];
          bodyTag.style.height = document.documentElement.clientWidth / screen.width * screen.height + 'px';
        }
        setTimeout(function () {
          window.scrollTo(0, 1)
        }, 0);
      };*/

//       window.imgsWH = {}
//
//       function getWHs(urlList) {
//         for (let i in urlList) {
//           getWH(urlList[i])
//         }
//       }
//
//       function getWH(url) {
//         if (window.imgsWH[url] === undefined) {
//           let img = new Image()
//           img.onload = function() {
//             console.log(this, this.width, this.height)
//             window.imgsWH[url] = [this.width, this.height]
//           }
//           img.src = url
//         }
//       }
//

      // 代码段A == START ==
      /* function setGesture(el) {
        var obj = {}; //定义一个对象
        var istouch = false;
        var start = [];
        el.addEventListener("touchstart", function(e) {
          // e.preventDefault();
          // window.event.cacenlBubble = false
          if (e.touches.length >= 2) { //判断是否有两个点在屏幕上
            istouch = true;
            start = e.touches; //得到第一组两个点
            obj.gesturestart && obj.gesturestart.call(el); //执行gesturestart方法
            // alert('双指');
          }
          else {
            // alert('单指');
          }
        }, false);
        document.addEventListener("touchmove", function(e) {
          e.preventDefault();
          // window.event.cacenlBubble = false
          if (e.touches.length >= 2 && istouch) {
            var now = e.touches; //得到第二组两个点
            var scale = getDistance(now[0], now[1]) / getDistance(start[0], start[1]); //得到缩放比例，getDistance是勾股定理的一个方法
            var rotation = getAngle(now[0], now[1]) - getAngle(start[0], start[1]); //得到旋转角度，getAngle是得到夹角的一个方法
            e.scale = scale.toFixed(2);
            e.rotation = rotation.toFixed(2);
            obj.gesturemove && obj.gesturemove.call(el, e); //执行gesturemove方法
          };
        }, false);
        document.addEventListener("touchend", function(e) {
          // e.preventDefault();
          // window.event.cacenlBubble = false
          if (istouch) {
            istouch = false;
            obj.gestureend && obj.gestureend.call(el); //执行gestureend方法
          };
        }, false);
        return obj;
      };

      function getDistance(p1, p2) {
        var x = p2.pageX - p1.pageX,
          y = p2.pageY - p1.pageY;
        return Math.sqrt((x * x) + (y * y));
      };

      function getAngle(p1, p2) {
        var x = p1.pageX - p2.pageX,
          y = p1.pageY - p2.pageY;
        return Math.atan2(y, x) * 180 / Math.PI;
      }; */
      // 代码段A === END ===
    </script>
  </body>
</html>
